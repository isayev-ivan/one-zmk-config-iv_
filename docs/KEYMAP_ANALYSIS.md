# Анализ раскладки `ergonaut_one.keymap`

Этот файл содержит вашу **текущую кастомную** раскладку клавиатуры. Она значительно отличается от стандартной версии и содержит продвинутые функции: макросы, комбо, Home Row Mods и специфические настройки для macOS.

## 1. Особенности конфигурации

*   **Home Row Mods (HRM):** Используются на домашнем ряду (A, S, D, F, J, K, L, ;).
    *   Реализованы через кастомные поведения `hrm_left` и `hrm_right`.
    *   **Логика:** При удержании клавиши работают как модификаторы (или переключение слоя), при нажатии — как буквы.
    *   **Балансировка:** Используется `flavor = "balanced"` и `require-prior-idle-ms`, что помогает избежать случайных срабатываний при быстром печатании.
*   **Слои на удержании (Layer-Tap):**
    *   Удержание `F` активирует слой 3 (`symbol_right`).
    *   Удержание `J` активирует слой 4 (`symbol_left`).
*   **Sticky Keys:** Настроен "липкий" Shift (`&sk`) с быстрым сбросом.

## 2. Макросы (Macros)

В секции `macros` определены автоматизации для macOS:

### Параметры макроса (Синтаксис Devicetree)
Каждый макрос имеет технические настройки, определяющие, как он вызывается и исполняется:
*   `#binding-cells = <0>;`: Означает, что макрос не принимает аргументов. Вы просто вызываете его по имени (например, `&mg_dot`), без дополнительных параметров.
*   `label`: Человекочитаемое имя для отладки или ссылки внутри системы.
*   `wait-ms`: Задержка (в миллисекундах) *между* нажатиями клавиш внутри макроса. Помогает, если ОС не успевает обрабатывать слишком быстрый ввод.
*   `tap-ms`: Длительность нажатия каждой клавиши внутри макроса. Если поставить слишком мало, некоторые системы могут пропустить нажатие.

### Список макросов:
1.  `mg_dot`: Вводит точку (Alt+7), пробел и активирует "липкий" Shift (следующая буква будет заглавной).
2.  `mg_comma`: Вводит запятую (Alt+6) и пробел.
3.  `mac_to_en`:
    *   Посылает шорткат `Shift+Ctrl+Alt+1` (для переключения раскладки в macOS).
    *   Переключает клавиатуру на слой 1 (`&to 1`).
4.  `mac_to_ru`:
    *   Посылает шорткат `Shift+Ctrl+Alt+2` (для переключения раскладки в macOS).
    *   Переключает клавиатуру на слой 0 (`&to 0`).

## 3. Комбо (Combos)

Настроено множество комбинаций клавиш (одновременное нажатие):

*   **Скобки:**
    *   `(`: `Z` + `X` (в нижнем ряду, поз. 28 27) - *Левая круглая*
    *   `)`: `N` + `M` (в нижнем ряду, поз. 31 32) - *Правая круглая*
    *   `[`: `F` + `G` (16 17) - *Левая квадратная*
    *   `]`: `H` + `J` (18 19) - *Правая квадратная*
    *   `{`: `T` + `R` (5 4) - *Левая фигурная*
    *   `}`: `Y` + `U` (6 7) - *Правая фигурная*
    *   `<`: `Z` + `C` (28 29) - *Меньше*
    *   `>`: `N` + `B` (31 30) - *Больше*
*   **Знаки:**
    *   `-`: `D` + `F` (15 16) - *Минус*
    *   `_`: `J` + `K` (19 20) - *Подчеркивание*
    *   `'` и `"`: На верхнем ряду (`E+R` и `U+I`).

## 4. Слои (Layers)

### Слой 0: `mac_default_ru`
Основной слой для русского языка.
*   **Буквы:** Стандартная QWERTY раскладка.
*   **Модификаторы:** `&mt` на внешних клавишах (Ctrl, Alt).
*   **HRM:**
    *   `F`: при удержании включает слой 3 (`symbol_right`).
    *   `J`: при удержании включает слой 4 (`symbol_left`).
*   **Thumb Cluster (Большие пальцы):**
    *   Левый: `Tab/Layer2`, `Space/Shift`, `Enter/Cmd`.
    *   Правый: `Esc/Cmd`, `Backspace/Shift`, `to_en_raise` (Макрос переключения на EN / Слой 2).

### Слой 1: `mac_en`
Слой для английского языка.
*   **Механизм переключения:**
    *   Выход со слоя осуществляется клавишей `to_ru_raise` (нижний правый угол).
    *   Она корректно вызывает макрос `mac_to_ru`, который переключает язык в ОС и возвращает клавиатуру на Слой 0 (`&to 0`). В этой части логика верна.
*   **⚠️ Проблема с буквами:**
    *   Макрос входа (`mac_to_en`) использует команду `&to 1`. Эта команда **отключает** все остальные слои, включая Слой 0.
    *   В текущем коде буквы на Слое 1 обозначены как `&trans` (прозрачные).
    *   Так как Слой 0 отключен, прозрачным клавишам некуда "проваливаться".
    *   **Результат:** Переключение языков сработает, но буквы печататься не будут.
    *   **Решение:** Замените `&trans` на конкретные коды клавиш (`&kp Q`, `&kp W`...), либо используйте `&tog 1` вместо `&to 1` в макросах (но `&to` надежнее для синхронизации).

### Слой 2: `raise_layer`
Цифровой и навигационный слой.
*   Цифры (Numpad) справа.
*   Стрелки управления курсором.
*   Управление громкостью и медиа.

### Слой 3 (`symbol_right`) и Слой 4 (`symbol_left`)
Слои символов, активируемые удержанием `F` и `J`.
*   Содержат символы, вводимые через Alt-коды (специфика русской раскладки macOS, где многие символы требуют Alt).
*   Используются поведения `bracket_left`, `minus_down` и другие кастомные `mod-morph`.

### Слой 5: `settings`
Системные настройки (Bluetooth, Reset), доступен через слой 2 (клавиша `mo 5`).

---
**Итог:** Конфигурация очень мощная. Логика переключения между слоями (вход/выход) реализована верно, но для работы букв на английском слое необходимо явно прописать их коды вместо `&trans`.

# Руководство по репозиторию ZMK Config (Ergonaut One)

Этот документ описывает структуру репозитория, назначение файлов и процесс настройки прошивки для клавиатуры Ergonaut One на базе ZMK.

## Обзор репозитория

Этот репозиторий содержит конфигурационные файлы для сборки прошивки ZMK. Прошивка собирается автоматически с помощью GitHub Actions при каждом обновлении репозитория.

## Структура файлов

### Основные файлы конфигурации (`config/`)

*   **`config/ergonaut_one.keymap`**: Самый важный файл. Он содержит определение раскладки клавиатуры: слои, назначение клавиш, поведение (mod-tap, layer-tap) и условные слои. Именно этот файл вы будете редактировать чаще всего.
*   **`config/ergonaut_one.conf`**: Файл конфигурации Kconfig. Здесь задаются системные настройки прошивки, такие как:
    *   Параметры Bluetooth (имя устройства, максимальное количество подключений).
    *   Управление питанием (таймауты сна и простоя).
    *   Включение/выключение функций (например, `CONFIG_ZMK_SLEEP` для глубокого сна).
    *   *Примечание: ZMK Studio включается не здесь, а в `build.yaml`.*
*   **`config/ergonaut_one.json`**: Файл с метаданными о физическом расположении клавиш (координаты, поворот). Используется инструментами визуализации (Keymap Drawer, ZMK Studio) для отрисовки красивой картинки клавиатуры. На саму прошивку не влияет.
*   **`config/west.yml`**: Манифест для инструмента `west` (аналог `package.json` в JS или `requirements.txt` в Python).
    *   **Зачем нужен:** Он говорит системе сборки, откуда качать исходный код ZMK и дополнительные модули.
    *   **Что внутри:**
        *   `remotes`: Список источников (GitHub репозитории).
        *   `projects`: Конкретные репозитории, которые нужно скачать.
            *   `zmk`: Основное ядро прошивки.
            *   `ergonautkb-zmk-module`: Специфичный код для клавиатуры Ergonaut One (определение платы, щилда и т.д.).
    *   **Когда трогать:** Только если вы хотите обновить версию ZMK (строка `revision: main`) или добавить сторонний модуль (например, для поддержки трекбола или мыши).

### Файлы сборки

*   **`build.yaml`**: Конфигурация матрицы сборки для GitHub Actions.
    *   **Что такое Board, Shield и Snippet?**
        *   **Board (`xiao_ble`)**: Это микроконтроллер, который стоит на клавиатуре. ZMK имеет встроенную поддержку множества плат.
        *   **Shield (`ergonaut_one_left`, `ergonaut_one_right`)**: Это сама печатная плата клавиатуры, которая подключается к контроллеру. Определение шилда (какие пины куда идут) берется из модуля `ergonautkb`, который подтягивается через `west.yml`.
        *   **Snippet (`studio-rpc-usb-uart`)**: Это маленький кусочек конфигурации (сниппет), который добавляет специфичные настройки. В данном случае он включает поддержку RPC (удаленного вызова процедур) через USB UART, что необходимо для работы ZMK Studio.
    *   **Откуда они берутся?**
        *   Стандартные платы и шилды есть в основном репозитории ZMK.
        *   Кастомные шилды (как Ergonaut One) подгружаются из сторонних модулей (см. `west.yml`).
*   **`.github/workflows/build.yml`**: Сценарий GitHub Actions. Запускает процесс сборки прошивки при пуше в репозиторий.

### Прочее

*   **`keymap-drawer/`**: Конфигурация для автоматической генерации визуализации раскладки (картинки SVG).
*   **`README.md`**: Базовая инструкция по прошивке и сопряжению половинок.

---

## Состав прошивки (Что внутри `firmware.zip`)

После успешной сборки вы получаете архив с несколькими `.uf2` файлами. Вот что означает каждый из них:

1.  **`ergonaut_one_left-xiao_ble-zmk.uf2`**
    *   **Назначение:** Основная прошивка для **левой** половинки клавиатуры.
    *   **Использование:** Прошивайте этот файл в левый контроллер, если вы **не планируете** использовать ZMK Studio для редактирования "на лету". Это самая стабильная и легкая версия.

2.  **`ergonaut_one_right-xiao_ble-zmk.uf2`**
    *   **Назначение:** Основная прошивка для **правой** половинки клавиатуры.
    *   **Использование:** Прошивайте этот файл в правый контроллер.

3.  **`ergonaut_one_left_studio.uf2`**
    *   **Назначение:** Прошивка для **левой** половинки с **включенной поддержкой ZMK Studio**.
    *   **Особенность:** Содержит дополнительный код для связи с приложением ZMK Studio.
    *   **Использование:** Прошивайте этот файл в левый контроллер, если хотите менять раскладку через графический интерфейс без перекомпиляции.

4.  **`ergonaut_one_right_studio.uf2`**
    *   **Назначение:** Прошивка для **правой** половинки с поддержкой ZMK Studio.
    *   **Использование:** Прошивайте в правый контроллер для работы с ZMK Studio.

5.  **`settings_reset-xiao_ble-zmk.uf2`**
    *   **Назначение:** Утилита для **сброса настроек Bluetooth**.
    *   **Что делает:** Полностью стирает информацию о сопряженных устройствах (bonding information) из памяти контроллера.
    *   **Когда использовать:**
        *   Если клавиатура перестала подключаться к компьютеру.
        *   Если половинки перестали видеть друг друга.
        *   Если вы хотите начать настройку Bluetooth "с чистого листа".
    *   **Как применять:** Прошейте этот файл в проблемную половинку (или в обе по очереди). После прошивки клавиатура ничего не будет делать (это нормально). Затем сразу же прошейте обычную прошивку (пункты 1-4).

---

## Как конфигурировать и редактировать прошивку

### 1. Редактирование раскладки (`config/ergonaut_one.keymap`)

Файл `keymap` использует синтаксис Devicetree. Все определения находятся внутри корневого узла `/ { ... }`.

#### Слои (Layers) и Условные слои (Conditional Layers)

Слои определяются внутри узла `keymap`. В текущей конфигурации есть 4 слоя:

1.  **`default_layer` (MAIN, ID 0)**: Основной слой (буквы).
2.  **`lower_layer` (SYM, ID 1)**: Символы и F-клавиши.
3.  **`raise_layer` (NUM, ID 2)**: Цифры, навигация, управление громкостью.
4.  **`adjust_layer` (ADJ, ID 3)**: Служебный слой (Bluetooth, Reset).

**Что такое `conditional_layers`?**

В начале файла `keymap` вы найдете блок `conditional_layers`. Он отвечает за логику "Если нажаты слои A и B, включить слой C".
Свойство `compatible = "zmk,conditional-layers"` говорит прошивке, что этот блок описывает логику слоев.

```dts
conditional_layers {
    compatible = "zmk,conditional-layers";
    tri-layer {
        if-layers = <LWR RSE>;  // Если активны слои Lower И Raise
        then-layer = <ADJ>;     // То включить слой Adjust
    };
};
```
Это позволяет активировать слой настроек (Adjust) одновременным нажатием клавиш Lower и Raise, не выделяя под него отдельную кнопку.

**Что значит свойство `compatible`?**

В файлах конфигурации ZMK (Devicetree) свойство `compatible` определяет **класс поведения** или тип драйвера для блока. Вот основные значения, которые вы можете встретить или использовать:

*   **Глобальные блоки:**
    *   `"zmk,keymap"` — Определяет сам массив раскладки.
    *   `"zmk,conditional-layers"` — Условная логика слоев.
    *   `"zmk,combos"` — Блок для комбинаций клавиш.

*   **Кастомные поведения (Behaviors):**
    *   `"zmk,behavior-hold-tap"` — База для Mod-Tap и Layer-Tap.
    *   `"zmk,behavior-macro"` — Для макросов.
    *   `"zmk,behavior-tap-dance"` — Разные действия на 1, 2, 3 нажатия.
    *   `"zmk,behavior-sticky-key"` — "Липкие" клавиши (нажал и отпустил Shift -> следующая буква заглавная).


### 2. Добавление Комбо (Combos)

Комбо позволяют активировать действие при одновременном нажатии нескольких клавиш.

**Куда добавлять:** В файл `config/ergonaut_one.keymap`, внутри корневого блока `/ { ... }`, но **вне** блока `keymap { ... }`. Обычно их размещают перед `keymap`.

**Синтаксис:**

```dts
/ {
    combos {
        compatible = "zmk,combos";
        
        // Пример: Нажатие J и K одновременно работает как ESC
        combo_esc {
            timeout-ms = <50>;      // Время ожидания нажатия второй клавиши (мс)
            key-positions = <19 20>; // Индексы клавиш (см. схему матрицы ниже)
            bindings = <&kp ESC>;
            layers = <0>;           // (Опционально) Работать только в слое 0
        };

        // Пример: Нажатие F и D одновременно работает как TAB
        combo_tab {
            timeout-ms = <50>;
            key-positions = <16 17>; 
            bindings = <&kp TAB>;
        };
    };

    keymap { ... };
};
```

**Как узнать индексы клавиш (`key-positions`):**
Для клавиатур 3x6+3 (как Ergonaut One/Corne) нумерация обычно идет построчно слева направо, начиная с 0.
*   Верхний ряд: 0-11
*   Средний ряд: 12-23
*   Нижний ряд: 24-35
*   Тамб кластер (большие пальцы): 36-41

*Совет: Сверьтесь с `ergonaut_one.svg` или документацией шилда, чтобы уточнить точные индексы.*

### 3. Добавление Макросов (Macros)

Макросы позволяют отправлять последовательность клавиш (например, ввод пароля или шортката).

**Куда добавлять:** Там же, где и комбо — внутри `/ { ... }`, перед `keymap`.

**Синтаксис:**

```dts
/ {
    macros {
        // Пример: Макрос "Привет"
        // Использование: &hi_macro
        hi_macro: hi_macro {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings
                = <&kp H &kp E &kp L &kp L &kp O>;
        };

        // Пример: Шорткат для macOS (Command+Shift+4 для скриншота)
        // ZMK выполняет нажатия последовательно. Для одновременного нажатия используйте модификаторы внутри kp.
        mac_screenshot: mac_screenshot {
            compatible = "zmk,behavior-macro";
            #binding-cells = <0>;
            bindings
                = <&macro_press &kp LGUI &kp LSHFT>
                , <&macro_tap &kp N4>
                , <&macro_release &kp LGUI &kp LSHFT>;
        };
    };

    keymap {
        default_layer {
            // Назначение макроса на клавишу
            bindings = <... &hi_macro ...>; 
        };
    };
};
```

### 4. Специфика macOS

Поскольку вы используете macOS, обратите внимание на следующие моменты:

*   **GUI (Command) vs ALT (Option):**
    *   В ZMK `&kp LGUI` / `&kp RGUI` соответствуют клавише **Command** (⌘).
    *   `&kp LALT` / `&kp RALT` соответствуют клавише **Option** (⌥).
    *   `&kp LCTRL` соответствует **Control** (^).
*   **Порядок клавиш:** На стандартных клавиатурах Mac порядок слева направо: Control -> Option -> Command.
    В вашем файле `keymap` проверьте нижний ряд (`default_layer`):
    *   Строка 36 (нижний буквенный ряд) имеет модификаторы `&mt LALT ...`.
    *   Строка 37 (большие пальцы) имеет `&mt LGUI ...`, `&mt LSHFT ...` и т.д.
    *   Убедитесь, что `&mt LGUI` находится там, где вам удобно нажимать Command (обычно под большим пальцем).

### 5. ZMK Studio

В вашем файле `build.yaml` включена поддержка ZMK Studio. Это делается через аргумент `cmake-args`.

```yaml
# build.yaml
include:
  - board: xiao_ble
    shield: ergonaut_one_left
    snippet: studio-rpc-usb-uart
    cmake-args: -DCONFIG_ZMK_STUDIO=y  <-- Включение ZMK Studio
    artifact-name: ergonaut_one_left_studio
```

**Что это дает:**
Вы можете менять раскладку (remap keys) в реальном времени, не перепрошивая клавиатуру каждый раз.

**Как пользоваться:**
1.  Скачайте ZMK Studio.
2.  Подключите клавиатуру.
3.  Разблокируйте изменение раскладки. В вашем `keymap` в слое `ADJ` (Adjust) уже есть клавиша `&studio_unlock`. Вам нужно перейти в слой Adjust (зажать Lower + Raise) и нажать эту клавишу.
4.  Вносите изменения в интерфейсе ZMK Studio.

**Важно:** Изменения, сделанные в ZMK Studio, сохраняются в памяти клавиатуры, но **не меняют** файл `config/ergonaut_one.keymap` в репозитории.
*   Если вы перепрошьете клавиатуру новой прошивкой из репозитория, настройки ZMK Studio могут быть перезаписаны (зависит от настроек очистки памяти).
*   Рекомендуется: использовать Studio для экспериментов, а финальную удобную раскладку переносить в код `ergonaut_one.keymap` для надежности и истории версий.

## Как применить изменения кода

1.  Отредактируйте файлы.
2.  Закоммитьте изменения и сделайте `git push`.
3.  GitHub Actions автоматически соберет новую прошивку.
4.  Скачайте артефакт `firmware.zip` из раздела Actions на GitHub.
5.  Прошейте клавиатуру.
